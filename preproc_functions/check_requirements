#!/bin/bash

function check_requirements {
    #preliminary checks for required files and settings
    
    #use the saved slice order from dicom_to_nifti conversion
    if [ -f .detect_sliceorder ]; then
	if [ -n "$sliceAcquisition" ]; then
	    rel "Ignoring user setting for slice acquisition: ${sliceAcquisition} because of auto-detected order in .detect_sliceorder." c
	fi
	
	read sliceAcquisition < .detect_sliceorder
    fi

    if [ -f .detect_tr ]; then
	if [ -n "$tr" ]; then
	    rel "Ignoring user setting for TR: ${tr} because of auto-detected TR in .detect_tr." c
	fi

	read tr < .detect_tr
    fi

    #use the saved series number and protocol name for epiref detection
    if [ -f .detect_series ]; then
	read series < .detect_series
    fi

    if [ -f .detect_protocolname ]; then
	read protocolname < .detect_protocolname
    fi

    #use detected epiref image to override directory, if specified
    if [ -f .detect_epiref ]; then
	read funcRefimg  < .detect_epiref
    fi
    
    
    #check that slice acquisition order and TR was specified or detected in case of 4d input
    if [ -n "$funcFile" ]; then
	if [[ -z $sliceAcquisition && $no_st -eq 0 && -z $sliceTimesFile ]]; then #only enforce provision of slice acquisition order if slice timing in pipeline.
	    echo -e "Slice acquisition order was not specified and not detected.\nPass using the -slice_acquisition parameter.\nExiting.\n"
	    exit 1
	fi

	if [ -z $tr ]; then
	    echo -e "TR was not specified and not detected.\nPass using the -tr parameter.\nExiting.\n"
	    exit 1
	fi

	#check number of slices
	#if DICOMs used, num slices will be picked up by preproc_functions/dicom_to_nifti
	detectSliceNum=$( fslhd ${funcFile}  | grep '^dim3' | perl -pe 's/dim3\s+(\d+)/\1/' )

    fi

    if [ -n "$funcRefimg" ]; then
	if [[ -d "$funcRefimg" && ! -r .epiref_bet_complete ]]; then
	    #if -funcRefImg is a directory, assume that this is the raw directory for the subject and we should detect the reference	    
	    #look for dicom in previous and following series
	    if [ -z "$series" ]; then
		echo "series variable not set, but -func_refimg detect specified. Cannot determine how to search for SBref"
		exit 1
	    fi

	    if [ -z "$protocolname" ]; then
		echo "protocolname variable not set, but -func_refimg detect specified. Cannot determine how to search for SBref"
		exit 1
	    fi
	    
	    #find first file matching the dicom pattern in subfolders of the directory
	    local rawdir=$funcRefimg
	    local sbrefFound=0
	    while IFS= read -r -d '' dir; do
		#echo "find '$dir' -iname '$dicomPattern' -type f -print -quit"
		firstDicom=$( find "$dir" -iname "$dicomPattern" -type f -print -quit )
		#echo "dcm: $firstDicom"
		
		if [ -n "${firstDicom}" ]; then #check the number of characters in the string
		    local cDicom=$( dicom_hdr -sexinfo "${firstDicom}" )
		    local cProtocol=$( echo "${cDicom}" | grep -i "ACQ Protocol Name" | perl -pe "s:.*ACQ Protocol Name//(\w+).*$:\1:" )
		    local cSeries=$( echo "${cDicom}" | grep "REL Series Number//" | perl -pe 's|^.*REL Series Number//(\d+).*$|\1|' ) #series number

		    echo "${cDicom}" | grep -q "REL Image Comments//Single-band reference" && local cSbref=1 || local cSbref=0
		    
		    #echo "cprotocol: $cProtocol, cSeries: $cSeries, issbref: $cSbref, series to match: $series, proto to match: $protocolname"
		    if [[ "$cProtocol" == "$protocolname" && ( $cSeries == $(( series - 1)) || $cSeries == $(( series + 1)) ) && $cSbref == 1 ]]; then
			sbrefFound=1
			funcRefimg="${firstDicom}"
			echo "${firstDicom}" > .detect_epiref
			rel "  Detected SBref image -func_refimg: ${funcRefimg}" c
			break
		    fi
		fi
	    done < <(find $rawdir -mindepth 1 -maxdepth 1 -type d -print0)

	    if [ $sbrefFound -eq 0 ]; then
		rel "Unable to detect -func_refimg in $rawdir. Cannot continue." c
		exit 1
	    fi
	fi
	
	if [[ ! -f "$funcRefimg" ]] && [[ ! -h "${funcRefimg}" ]]; then
	    echo -e "Functional reference scan (-func_refimg) specified but not found: ${funcRefimg}.\nExiting.\n"
	    exit 1
	fi

	if [ -n "$ref_vol" ]; then
	    echo "-ref_vol and -func_refimg specified. Ignoring -ref_vol and using -func_refimg $funcRefimg."
	    ref_vol=
	fi

	if [ ! -r .epiref_bet_complete ]; then	   
	    #if funcRegimg is a single DICOM file, change to NIfTI
	    dicom_hdr "$funcRefimg" 2>&1 | grep -q "ERROR: can't open.*as a DICOM file" && isdicom=0 || isdicom=1 # 0 exit status from grep indicates a match

	    if [ $isdicom -eq 1 ]; then
		rel "Converting -func_refimg to NIfTI" c
		rel "to3d -prefix epiref.nii.gz -ushort2float \"$funcRefimg\""
	    else
		#copy reference image to local directory to make directory more portable
		rel "fslmaths \"$funcRefimg\" epiref"
	    fi
	    
	    #skull strip reference image to improve coregistration
	    rel "bet epiref epiref_brain -f 0.3 -n -R" #include bias field correction given heavy bias for 32-channel data
	    rel "fast -o epiref_brain -l 20 -b -B -t 2 --iter=12 --nopve --fixed=0 epiref_brain"
	    rel "imrm epiref_brain_seg" #not needed for anything
	    #use epiref_brain_restore for coregistration

	    rel "date > .epiref_bet_complete"
	fi
    fi

    #if no warp and ICA-AROMA are both requested, we must compute the warp to MNI to have the script work properly
    if [[ $no_warp -eq 1 && $ica_aroma -eq 1 ]]; then
	compute_warp=1
    fi
    
    #check for existence of required files
    #mprageBet and warpCoef only required if warping to a standard template (or just computing via -compute_warp_only).
    #Thus, don't require for pure -no_warp runs.
    if [[ $no_warp -eq 0 && $compute_warp -eq 0 ]]; then
	if [ -z $mprageBet ]; then
	    echo -e "Betted mprage file parameter not provided.\nPass using the -mprage_bet parameter.\nExiting.\n"
	    exit 1
	elif [[ ! -f $mprageBet ]] && [[ ! -h ${mprageBet} ]]; then
	    echo -e "Betted mprage file: $mprageBet does not exist.\nExiting.\n"
	    exit 1
	else
	    #make mprage into an absolute path and symlink within the current directory
	    cd "$(dirname $mprageBet)"
	    mprageBet="$(pwd)/$(basename $mprageBet)"
	    cd - 1>/dev/null
	    # do not link if mprage is in the directory already #WF for MJ 20150424
	    [ ! -r "./$(basename $mprageBet)" ] && \
	      ln -sfn "$mprageBet" "./$(basename $mprageBet)"
	fi

	
	if [ -z $warpCoef ]; then
	    echo -e "Structural to standard space warp coefficients file (from FNIRT) not provided.\nPass using the -warpcoef parameter.\nExiting.\n"
	    exit 1
	elif [[ ! -f $warpCoef ]] && [[ ! -h ${warpCoef} ]]; then
	    echo "Structural to standard space warp coefficients file does not exist.\nFile specified: $warpCoef.\nExiting.\n"
	    exit 1
	fi
    fi
}
